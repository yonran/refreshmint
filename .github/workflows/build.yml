name: Build

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      bundle: app
                    - os: macos-13
                      target: x86_64-apple-darwin
                      bundle: app
                    - os: ubuntu-22.04
                      target: x86_64-unknown-linux-gnu
                      bundle: deb
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      bundle: nsis

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install Linux dependencies
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

            - name: Install npm dependencies
              run: npm ci

            - name: Download hledger sidecar
              run: bash scripts/download-sidecar.sh ${{ matrix.target }}

            - name: Build frontend
              run: npm run build

            - name: Cargo check
              working-directory: src-tauri
              run: cargo check --target ${{ matrix.target }}

            - name: Cargo test
              working-directory: src-tauri
              run: cargo test --target ${{ matrix.target }}

            - name: Cargo clippy
              working-directory: src-tauri
              run: cargo clippy --target ${{ matrix.target }} --all-targets -- -D warnings

            - name: Build Tauri bundle
              run: npm exec tauri build -- --target ${{ matrix.target }} --bundles ${{ matrix.bundle }}

            - name: Upload bundle artifacts
              if: ${{ env.ACT != 'true' }}
              uses: actions/upload-artifact@v4
              with:
                  name: bundle-${{ matrix.target }}
                  path: src-tauri/target/${{ matrix.target }}/release/bundle/
